#!/usr/bin/env ruby
# coding: utf-8
# Copyright muflax <mail@muflax.com>, 2011
# License: GNU GPL 3 <http://www.gnu.org/copyleft/gpl.html>

require "parallel"

# where to store the backup?
Target = File.join(Dir.home, "www")

# number of parallel wgets
Parallel_num = 20

# filtered hosts
Hosts = [
         # chans
         /\d+chan\.\w+/,

         # video sites
         /beeq\.com/,
         /motherless\.com/,
         /mypinktube\.com/,
         /thedailyshow\.com/,
         /vimeo\.com/,
         /youtube\.com/,
         
         # search sites
         /\/search\.php/,
         /findtubes\.com/,
         /google\.com\/search/,
         /isohunt\.com/,
         /jpopsuki\.eu/,
         /library\.nu\/search/,
         /piratebay\.org/,
         /wikipedia.*search=\w+/,

         # hosting sites
         /megaupload\.com/,
         /rapidshare\.com/,

         # random sites
         /github\.com/,
         /google\.\w+/,

         # archives
         /archive\.org/,
         /webcache\.googleusercontent\.com/,
         
         # session ids
         /sid=\w+/,
        
         # local IPs
         /127\.0\.0\.1/,
         /192\.\d+\.\d+\.\d+/,
         /localhost/,

         # admin pages
         /blog\.muflax\.com\/wp-admin/,
        ]

# skip this stuff
Extensions = [
              # execs
              "bin",
              "exe",
              "iso",
              "jar",

              # archives
              "7z",
              "bz2",
              "gz",
              "rar",
              "tar",
              "xz",
              "zip",

              # video / audio
              "avi",
              "flv",
              "mkv",
              "mov",
              "mp3",
              "mp4",
              "ogg",
              "swf"
              "webm",
              "wmv",

              # docs
              "djvu",
              "epub",
              "mobi",
              "pdf",

              # misc
              "torrent",
             ]

# delete files over that size
FileLimit = "4M"

def filter_urls urls
  puts "filtering urls..."

  # remove trailing slashes
  urls.map!{|u| u.chomp.sub(%r{/$}, "")}

  # remove duplicates
  urls.uniq!

  # remove local files
  urls.delete_if{|u| u.match /^file:/}

  # remove useless hosts
  Hosts.each{|host| urls.delete_if{|u| u.match host}}

  # remove all file extensions (wget doesn't catch them
  Extensions.each{|ext| urls.delete_if{|u| u.match /\.#{ext}\b/}}
  
  # shuffle them to avoid polling the same server
  urls.shuffle!

  urls
end

urls = filter_urls ARGF.to_a

puts "mirroring into #{Target}..."
Dir.chdir Target

exts = Extensions.map{|e| ".#{e}"}.join(",")
opts = "--no-verbose --continue --page-requisites -e robots=off --timestamping --reject #{exts} --timeout=30 --ignore-case --convert-links"

Parallel.each_with_index(urls, :in_threads=>Parallel_num) do |url, i|
  puts "backing up (#{i}/#{urls.size}): #{url}"
  system "wget #{opts} #{url}"
end

# remove duplicates
system "hardlink -t #{Target}"

# remove large files
system "find #{Target} -size '+#{FileLimit}' -delete"
